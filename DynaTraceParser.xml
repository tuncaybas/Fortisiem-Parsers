<eventParser name="DynaTraceParser">
  <deviceType>
    <Vendor>Compuware</Vendor>
    <Model>Dynatrace App Monitoring</Model>
    <Version>ANY</Version>
  </deviceType>

  <patternDefinitions>
    <pattern name="patTwoDigits"><![CDATA[\d{2}]]></pattern>
  </patternDefinitions>

  <eventFormatRecognizer><![CDATA[SNMPv2-SMI::enterprises\.31094\.0\.1]]></eventFormatRecognizer>

  <testEvents>
    <testEvent><![CDATA[2015-03-27 15:32:55 0.0.0.0TRAP2, SNMP v2c, community public	. Cold Start Trap (0) Uptime: 0:00:00.00	DISMAN-EVENT-MIB::sysUpTimeInstance = Timeticks: (68894422) 7 days, 23:22:24.22	SNMPv2-MIB::snmpTrapOID.0 = OID: SNMPv2-SMI::enterprises.31094.0.1	SNMPv2-MIB::sysDescr.0 = STRING: dynaTrace Trap	SNMPv2-SMI::enterprises.31094.1.1 = STRING: "AccelOps - Test 2"	SNMPv2-SMI::enterprises.31094.1.2 = STRING: "Host Performance/Disk Storage Utilization : Disk Storage Utilization [disk->C:\] <all-applications> (Host-Agent@bik-con-bck3) upper bound exceeded"	SNMPv2-SMI::enterprises.31094.1.3 = Hex-STRING: 5A 75 BF 79 63 69 65 20 64 79 73 6B 75 20 3E 20 31 30 25 	SNMPv2-SMI::enterprises.31094.1.4 = STRING: "Warning"	SNMPv2-SMI::enterprises.31094.1.5 = STRING: "11111111-1111-1111-1111-111111111111"	SNMPv2-SMI::enterprises.31094.1.6 = STRING: "dtctst01"	SNMPv2-SMI::enterprises.31094.1.7 = STRING: "Monitoring"	SNMPv2-SMI::enterprises.31094.1.8 = STRING: "20150327163220"	SNMPv2-SMI::enterprises.31094.1.11 = STRING: "-"	SNMPv2-SMI::enterprises.31094.1.12 = STRING: "-"	SNMPv2-SMI::enterprises.31094.1.13.1 = STRING: "Immediate"	SNMPv2-SMI::enterprises.31094.1.13.2 = Timeticks: (0) 0:00:00.00	SNMPv2-SMI::enterprises.31094.1.13.3 = Timeticks: (0) 0:00:00.00	SNMPv2-SMI::enterprises.31094.1.13.4 = Timeticks: (60000) 0:10:00.00	SNMPv2-SMI::enterprises.31094.1.14.1.2.1 = STRING: "10.0"	SNMPv2-SMI::enterprises.31094.1.14.1.2.2 = STRING: "10.0"	SNMPv2-SMI::enterprises.31094.1.15.1.2.1.1 = STRING: "Disk Storage Utilization [disk->C:\] <all-applications> (Host-Agent@bik-con-bck3)"	SNMPv2-SMI::enterprises.31094.1.15.1.2.2.1 = STRING: "Disk Storage Utilization"	SNMPv2-SMI::enterprises.31094.1.15.1.3.1.1 = STRING: "Used storage space on medium."	SNMPv2-SMI::enterprises.31094.1.15.1.3.2.1 = STRING: "Used storage space on medium."	SNMPv2-SMI::enterprises.31094.1.15.1.4.1.1 = STRING: "<all-applications>"	SNMPv2-SMI::enterprises.31094.1.15.1.4.2.1 = STRING: "-"	SNMPv2-SMI::enterprises.31094.1.15.1.5.1.1 = ""	SNMPv2-SMI::enterprises.31094.1.15.1.5.2.1 = ""	SNMPv2-SMI::enterprises.31094.1.15.1.6.1.1 = STRING: "%"	SNMPv2-SMI::enterprises.31094.1.15.1.6.2.1 = STRING: "%"	SNMPv2-SMI::enterprises.31094.1.15.1.7.1.1 = STRING: "Disk Storage Utilization"	SNMPv2-SMI::enterprises.31094.1.15.1.7.2.1 = STRING: "Disk Storage Utilization"	SNMPv2-SMI::enterprises.31094.1.15.1.8.1.1 = STRING: "Used storage space on medium."	SNMPv2-SMI::enterprises.31094.1.15.1.8.2.1 = STRING: "Used storage space on medium."	SNMPv2-SMI::enterprises.31094.1.15.1.9.1.1 = STRING: "Host Performance"]]></testEvent>
  </testEvents>

  <parsingInstructions>
    <collectFieldsByRegex src="$_rawmsg">
      <regex><![CDATA[<_year:gPatYear>-<_mon:gPatMonNum>-<_day:gPatDay>\s+<_time:gPatTime>\s+<_body:gPatMesgBody>]]></regex>
    </collectFieldsByRegex>

    <setEventAttribute attr="deviceTime">toDateTime($_mon, $_day, $_year, $_time)</setEventAttribute>
    <setEventAttribute attr="eventType">Dynatrace-Generic</setEventAttribute>
    <setEventAttribute attr="extEventRecvProto">Snmp Trap</setEventAttribute>

    <collectAndSetAttrByKeyValuePair sep="\t\\| SNMPv2" src="$_body">
      <attrKeyMap attr="_id" key="SNMPv2-MIB::snmpTrapOID.0 = OID: "/>
      <attrKeyMap attr="alertName" key="SNMPv2-SMI::enterprises.31094.1.1 = STRING: "/>
      <attrKeyMap attr="_fullMsg" key="SNMPv2-SMI::enterprises.31094.1.2 = STRING: "/>
      <attrKeyMap attr="description" key="SNMPv2-SMI::enterprises.31094.1.3 = STRING: "/>
      <attrKeyMap attr="_severity" key="SNMPv2-SMI::enterprises.31094.1.4 = STRING: "/>
      <attrKeyMap attr="hostName" key="SNMPv2-SMI::enterprises.31094.1.6 = STRING: "/>
      <attrKeyMap attr="profileDetails" key="SNMPv2-SMI::enterprises.31094.1.7 = STRING: "/>
      <attrKeyMap attr="_startTime" key="SNMPv2-SMI::enterprises.31094.1.8 = STRING: "/>
      <attrKeyMap attr="_endTime" key="SNMPv2-SMI::enterprises.31094.1.9 = STRING: "/>
      <attrKeyMap attr="_durationSec" key="SNMPv2-SMI::enterprises.31094.1.10 = STRING: "/>
      <attrKeyMap attr="jobDesc" key="SNMPv2-SMI::enterprises.31094.1.15.1.3.2.1 = STRING: "/>
      <attrKeyMap attr="appGroupName" key="SNMPv2-SMI::enterprises.31094.1.15.1.4.1.1 = STRING: "/>
    </collectAndSetAttrByKeyValuePair>

    <when test="exist _durationSec">
      <setEventAttribute attr="durationMSec">scale($_durationSec, 1000)</setEventAttribute>
    </when>

    <when test="exist _startTime">
      <collectFieldsByRegex src="$_startTime">
        <regex><![CDATA[<_year:gPatYear><_mon:gPatMonNum><_day:gPatDay><_hour:patTwoDigits><_min:patTwoDigits><_sec:patTwoDigits>]]></regex>
      </collectFieldsByRegex>
      <setEventAttribute attr="_startTimeFormatted">combineMsgId($_hour, ":", $_min, ":", $_sec)</setEventAttribute>
      <setEventAttribute attr="startTime">toDateTime($_mon, $_day, $_year, $_startTimeFormatted)</setEventAttribute>
    </when>

    <when test="exist _endTime">
      <collectFieldsByRegex src="$_endTime">
        <regex><![CDATA[<_year:gPatYear><_mon:gPatMonNum><_day:gPatDay><_hour:patTwoDigits><_min:patTwoDigits><_sec:patTwoDigits>]]></regex>
      </collectFieldsByRegex>
      <setEventAttribute attr="_endTimeFormatted">combineMsgId($_hour, ":", $_min, ":", $_sec)</setEventAttribute>
      <setEventAttribute attr="endTime">toDateTime($_mon, $_day, $_year, $_startTimeFormatted)</setEventAttribute>
    </when>

    <when test="exist _fullMsg">
      <collectFieldsByRegex src="$_fullMsg">
        <regex><![CDATA[^<_et:gPatStrEndColon>:<msg:gPatMesgBody>]]></regex>
      </collectFieldsByRegex>

      <setEventAttribute attr="_et">replaceStringByRegex($_et, "\s|/", "-")</setEventAttribute>
      <setEventAttribute attr="eventType">combineMsgId("Dynatrace-", $_et)</setEventAttribute>
    </when>

    <choose>
      <when test="not_exist _severity"/>

      <when test="$_severity = 'Warning'">
        <setEventAttribute attr="eventSeverity">5</setEventAttribute>
      </when>

      <when test="$_severity = 'Error'">
        <setEventAttribute attr="eventSeverity">9</setEventAttribute>
      </when>

      <otherwise>
        <setEventAttribute attr="eventSeverity">1</setEventAttribute>
      </otherwise>
    </choose>

    <when test="exist alertName">
      <setEventAttribute attr="serviceName">$alertName</setEventAttribute>
    </when>
  </parsingInstructions>
</eventParser>
