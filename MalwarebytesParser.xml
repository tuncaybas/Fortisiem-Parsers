<eventParser name="MalwarebytesParser">

  <deviceType>
    <Vendor>Malwarebytes</Vendor>
    <Model>Endpoint Protection</Model>
    <Version>ANY</Version>
  </deviceType>

  <testEvents>
    <testEvent><![CDATA[<45>1 2016-09-23T14:40:35.82-06:00 reportDeviceName Malwarebytes-Endpoint-Security 1552 - - {"security_log":{"client_id":"11111111-1111-1111-1111-111111111111","host_name":"Abc-cbd","domain":"abc.com","mac_address":"FF-FF-FF-FF-FF","ip_address":"10.1.1.1","time":"2016-09-23T14:40:14","threat_level":"Moderate","object_type":"FileSystem","object":"HKLM\\SOFTWARE\\POLICIES\\GOOGLE\\UPDATE","threat_name":"PUM.Optional.DisableChromeUpdates","action":"Quarantine","operation":"QUARANTINE","resolved":true,"logon_user":"dsamuels","data":"data","description":"No description","source":"MBAM","payload":null,"payload_url":null,"payload_process":null,"application_path":null,"application":null}}]]></testEvent>
  </testEvents>
  <eventFormatRecognizer><![CDATA[<:gPatSyslogPRI>\d+\s+<:gPatYear>-<:gPatMonNum>-<:gPatDay>T<:gPatTime>\.\d+-\d+:\d+\s+<:gPatStr>\s+Malwarebytes-Endpoint-Security\s+\d+\s*-\s*-\s]]></eventFormatRecognizer>

  <parsingInstructions>
    <collectFieldsByRegex src="$_rawmsg">
      <regex><![CDATA[<:gPatSyslogPRI>\d+\s+<:gPatYear>-<:gPatMonNum>-<:gPatDay>T<:gPatTime>\.\d+-\d+:\d+\s+<reptDevName:gPatStr>\s+Malwarebytes-Endpoint-Security\s+\d+\s*-\s*-\s*\{\"security_log\":<_body:gPatMesgBody>\}]]></regex>
    </collectFieldsByRegex>

    <setEventAttribute attr="eventType">Malwarebytes_Generic</setEventAttribute>
    <collectAndSetAttrByJSON src="$_body">
      <attrKeyMap attr="userId" key="client_id"/>
      <attrKeyMap attr="hostName" key="host_name"/>
      <attrKeyMap attr="domain" key="domain"/>
      <attrKeyMap attr="_hostMACAddr" key="mac_address"/>
      <attrKeyMap attr="hostIpAddr" key="ip_address"/>
      <attrKeyMap attr="_actionTime" key="time"/>
      <attrKeyMap attr="threatLevel" key="threat_level"/>
      <attrKeyMap attr="objType" key="object_type"/>
      <attrKeyMap attr="osObjName" key="object"/>
      <attrKeyMap attr="virusName" key="threat_name"/>
      <attrKeyMap attr="virusAction" key="action"/>
      <attrKeyMap attr="opName" key="operation"/>
      <attrKeyMap attr="status" key="resolved"/>
      <attrKeyMap attr="user" key="logon_user"/>
      <attrKeyMap attr="details" key="data"/>
      <attrKeyMap attr="description" key="description"/>
      <attrKeyMap attr="dataSource" key="source"/>
      <attrKeyMap attr="dataPayload" key="payload"/>
      <attrKeyMap attr="infoURL" key="payload_url"/>
      <attrKeyMap attr="procName" key="payload_process"/>
      <attrKeyMap attr="appName" key="application"/>
    </collectAndSetAttrByJSON>
    <when test="exist _actionTime">
      <collectFieldsByRegex src="$_actionTime">
        <regex><![CDATA[<_year:gPatYear>-<_mon:gPatMonNum>-<_day:gPatDay>T<_time:gPatTime>]]></regex>
      </collectFieldsByRegex>
      <setEventAttribute attr="deviceTime">toDateTime($_mon, $_day, $_year, $_time)</setEventAttribute>
    </when>
    <when test="exist _hostMACAddr">
      <setEventAttribute attr="hostMACAddr">normalizeMAC($_hostMACAddr)</setEventAttribute>
    </when>
    <when test="exist virusAction">
      <setEventAttribute attr="eventType">combineMsgId("Malwarebytes_",$virusAction)</setEventAttribute>
      <choose>
        <when test="$status = 'true'">
          <setEventAttribute attr="eventType">combineMsgId($eventType,"_Resolved")</setEventAttribute>
        </when>
        <when test="$status = 'false'">
          <setEventAttribute attr="eventType">combineMsgId($eventType,"_NotResolved")</setEventAttribute>
        </when>
      </choose>
    </when>
    <setEventAttribute attr="eventType">replaceStringByRegex($eventType, "\s+", "_")</setEventAttribute>
  </parsingInstructions>

  <when test="exist infoURL">
    <setEventAttribute attr="destName">extractHostFromURL($infoURL)</setEventAttribute>
  </when>
</eventParser>
