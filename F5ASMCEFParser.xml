<eventParser name="F5ASMCEFParser">
  <deviceType>
    <Vendor>F5</Vendor>
    <Model>Big-IPOS</Model>
    <Version>ANY</Version>
  </deviceType>

  <eventFormatRecognizer><![CDATA[\s+ASM:CEF:0\|F5\|ASM\|]]></eventFormatRecognizer>
  <testEvents>
    <testEvent><![CDATA[<134>Jun 26 14:18:56 f5virtual.abc.com ASM:CEF:0|F5|ASM|10.2.1|Successful Request|Successful Request|2|dvchost=f5virtual.abc.com dvc=192.168.1.151 cs1=master-key_default cs1Label=policy_name cs2=master-key cs2Label=web_application_name deviceCustomDate1=Jul 13 2011 16:24:25 deviceCustomDate1Label=policy_apply_date externalId=3601068286554428885 act=passed cn1=404 cn1Label=response_code src=10.10.77.54 spt=49399 dst=10.10.175.82 dpt=443 requestMethod=POST app=HTTPS request=/ipp/port1 cs5=N/A cs5Label=x_forwarded_for_header_value rt=Jun 26 2012 14:18:55 deviceExternalId=0 cs4=N/A cs4Label=attack_type cs6=N/A cs6Label=geo_location cs3Label=full_request cs3=POST /ipp/port1 HTTP/1.1\r\nHost: 127.0.0.1:631\r\nCache-Control: no-cache\r\nContent-Type: application/ipp\r\nAccept: application/ipp\r\nUser-Agent: Hewlett-Packard IPP\r\nContent-Length: 9\r\n\r\n]]></testEvent>
    <testEvent><![CDATA[<131>Jun 26 14:18:59 f5virtual.abc.com ASM:CEF:0|F5|ASM|10.2.1|200100043|bad HTTP/1.1 request, Potentially worm attack|5|dvchost=f5virtual.abc.com dvc=192.168.1.151 cs1=master-key_default cs1Label=policy_name cs2=master-key cs2Label=web_application_name deviceCustomDate1=Jul 13 2011 16:24:25 deviceCustomDate1Label=policy_apply_date externalId=3601068286554428909 act=alerted cn1=400 cn1Label=response_code src=10.10.77.54 spt=49782 dst=10.10.175.82 dpt=443 requestMethod=GET app=HTTPS request=/ cs5=N/A cs5Label=x_forwarded_for_header_value rt=Jun 26 2012 14:18:58 deviceExternalId=0 cs4=Other Application Attacks cs4Label=attack_type cs6=N/A cs6Label=geo_location cs3Label=full_request cs3=GET / HTTP/1.1\r\n\r\n]]></testEvent>
    <testEvent><![CDATA[<132>Oct  6 06:58:22 f5virtual.abc.com ASM:CEF:0|F5|ASM||Expired timestamp|Expired timestamp|4|dvchost= dvc= cs1=/Common/pol_siem cs1Label=policy_name cs2=/Common/pol_siem cs2Label=http_class_name deviceCustomDate1=Oct 04 2016 11:52:21 deviceCustomDate1Label=policy_apply_date externalId=12245781097606021179 act=blocked cn1=0 cn1Label=response_code src=192.168.250.200 spt=61474 dst=192.168.250.231 dpt=443 requestMethod=GET app=HTTPS cs5=N/A cs5Label=x_forwarded_for_header_value rt=Oct 06 2016 06:58:22 deviceExternalId=0 cs4=N/A cs4Label=attack_type cs6=N/A cs6Label=geo_location c6a1= c6a1Label=device_address c6a2= c6a2Label=source_address c6a3= c6a3Label=destination_address c6a4=N/A c6a4Label=ip_address_intelligence msg=N/A suid=ad1e2a29127a893b suser=N/A cn2=3 cn2Label=violation_rating cn3=0 cn3Label=device_id request=/cmd.exe cs3Label=full_request cs3=GET /cmd.exe HTTP/1.1\r\nHost: 192.168.250.231\r\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:49.0) Gecko/20100101 Firefox/49.0\r\nAccept: text/html,application/xhtml+xml,application/xml;q\=0.9,*/*;q\=0.8\r\nAccept-Language: en-US,en;q\=0.5\r\nAccept-Encoding: gzip, deflate, br\r\nCookie: TS01b03011\=01f4989be346729d23abec7942cccacb13a01b10f679414f132cca5762551eccbc6f2ca5b9b27ab617d91e47a678c4554755bb9f31\r\nConnection: keep-alive\r\nUpgrade-Insecure-Requests: 1\r\nCache-Control: max-age\=0\r\n\r\n]]></testEvent>
  </testEvents>

  <patternDefinitions>
    <pattern name="patMess"><![CDATA[[^|]+]]></pattern>
    <pattern name="patRequest"><![CDATA[.*]]></pattern>
  </patternDefinitions>

  <parsingInstructions>

    <setEventAttribute attr="eventType">"F5-ASM-Generic"</setEventAttribute>

    <collectFieldsByRegex src="$_rawmsg">
      <regex><![CDATA[<:gPatSyslogPRI><:gPatMon>\s+<:gPatDay>\s+<:gPatTime>\s+<:gPatStr>\s+ASM:CEF:\d+\|F5\|ASM\|[^|]*\|<_f5eventID:patMess>\|<eventDesc:patMess>\|<eventSeverity:gPatInt>\|<_body:gPatMesgBody>]]></regex>
    </collectFieldsByRegex>

    <setEventAttribute attr="eventType">combineMsgId("F5-ASM", "-", $_f5eventID)</setEventAttribute>
    <when test="not_matches($_f5eventID, '\d+')">
      <setEventAttribute attr="eventType">replaceStringByRegex($eventType, "\s", "_")</setEventAttribute>
    </when>

    <collectFieldsByKeyValuePair sep=" " kvsep="=" src="$_body">
      <attrKeyMap attr="reptDevName" key="dvchost"/>
      <attrKeyMap attr="reptDevIpAddr" key="dvc"/>
      <attrKeyMap attr="policyName" key="cs1"/>
      <attrKeyMap attr="webAppName" key="cs2"/>
      <attrKeyMap attr="f5ExtId" key="externalId"/>
      <attrKeyMap attr="fwAction" key="act"/>
      <attrKeyMap attr="httpStatusCode" key="cn1"/>
      <attrKeyMap attr="srcIpAddr" key="src"/>
      <attrKeyMap attr="srcIpPort" key="spt"/>
      <attrKeyMap attr="destIpAddr" key="dst"/>
      <attrKeyMap attr="destIpPort" key="dpt"/>
      <attrKeyMap attr="httpMethod" key="requestMethod"/>
      <attrKeyMap attr="appName" key="app"/>
      <attrKeyMap attr="infoURL" key="request"/>
      <attrKeyMap attr="f5XForHeader" key="cs5"/>
      <attrKeyMap attr="f5DevExtId" key="deviceExternalId"/>
      <attrKeyMap attr="eventTypeGrp" key="cs4"/>
      <attrKeyMap attr="_f5geo" key="cs6"/>
      <attrKeyMap attr="_updateTime" key="deviceCustomDate1"/>
      <attrKeyMap attr="_deviceTime" key="rt"/>
      <attrKeyMap attr="httpFullRequest" key="cs3"/>
    </collectFieldsByKeyValuePair>

    <collectFieldsByRegex src="$_updateTime">
      <regex><![CDATA[^<_mon:gPatMon>\s+<_day:gPatDay>\s+<_year:gPatYear>\s+<_time:gPatTime>]]></regex>
    </collectFieldsByRegex>
    <setEventAttribute attr="updateTime">toDateTime($_mon, $_day, $_year, $_time)</setEventAttribute>

    <collectFieldsByRegex src="$_deviceTime">
      <regex><![CDATA[^<_mon:gPatMon>\s+<_day:gPatDay>\s+<_year:gPatYear>\s+<_time:gPatTime>]]></regex>
    </collectFieldsByRegex>
    <setEventAttribute attr="deviceTime">toDateTime($_mon, $_day, $_year, $_time)</setEventAttribute>

    <when test="exist httpFullRequest">
      <collectFieldsByRegex src="$_body">
        <regex><![CDATA[ cs3=<httpFullRequest:gPatMesgBodyMin>(?:\s+\w+=|$)]]></regex>
      </collectFieldsByRegex>
      <switch>
        <case>
          <collectFieldsByRegex src="$httpFullRequest">
            <regex><![CDATA[^<httpMethod:gPatWord>\s+<infoURL:gPatStr>\s+HTTP/[\d.]+\\r\\n<_httpInfo:gPatMesgBody>]]></regex>
          </collectFieldsByRegex>

          <setEventAttribute attr="_httpInfo">replaceStringByRegex($_httpInfo, "\\r\\n", "::SEP::")</setEventAttribute>

          <collectFieldsByKeyValuePair sep="::SEP::" kvsep=": " src="$_httpInfo">
            <attrKeyMap attr="httpAcceptLang" key="Accept-Language"/>
            <attrKeyMap attr="httpReferrer" key="Referer"/>
            <attrKeyMap attr="httpUserAgent" key="User-Agent"/>
            <attrKeyMap attr="httpHost" key="Host"/>
            <attrKeyMap attr="httpContentType" key="Content-Type"/>
            <attrKeyMap attr="httpContentLen64" key="Content-Length"/>
            <attrKeyMap attr="httpConnStatus" key="Connection"/>
            <attrKeyMap attr="cookie" key="Cookie"/>
          </collectFieldsByKeyValuePair>
        </case>
        <default/>
      </switch>
    </when>

    <when test="exist infoURL">
      <setEventAttribute attr="destName">extractHostFromURL($infoURL)</setEventAttribute>
    </when>
  </parsingInstructions>
</eventParser>
