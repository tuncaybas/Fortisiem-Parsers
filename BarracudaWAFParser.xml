<eventParser name="BarracudaWAFParser">
  <deviceType>
    <Vendor>Barracuda</Vendor>
    <Model>Web Application Firewall</Model>
    <Version>ANY</Version>
  </deviceType>

  <testEvents>
    <testEvent><![CDATA[<134>Sep  1 13:10:09 nlb_lab 2021-09-01 13:10:09.163 -0600  nlb_lab NF INFO TCP 192.168.9.105 443 ALLOW traffic:allow]]></testEvent>
    <testEvent><![CDATA[<132>Sep  1 13:10:09 nlb_lab 2021-09-01 13:10:09.550 -0600  nlb_lab WF WARN UNRECOGNIZED_COOKIE 98.98.98.22 51415 192.168.9.110 443 global GLOBAL LOG NONE [Cookie\="_derived_epik" Service-created\="1565 days back" Reason\="No valid encrypted pair"] GET test.example.com/random_page TLSv1.2 "-" "Mozilla/5.0 (Linux; Android 11; SAMSUNG SM-G991U) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/15.0 Chrome/90.0.4430.210 Mobile Safari/537.36" 98.98.98.22 51415 "-" https://test.example.com/]]></testEvent>
    <testEvent><![CDATA[<134>Sep  1 13:10:11 nlb_lab 2021-09-01 13:10:11.342 -0600  nlb_lab TR 192.168.9.105 443 192.168.8.134 53619 "-" "-" POST TLSv1.2 test.example.com HTTP/1.1 200 736974 439 0 104 10.20.20.102 443 103 "-" SERVER DEFAULT PASSIVE VALID /json/reply/TicketingEventsGetAvailableByEventTypeName "-" "-" "-" "ServiceStack .NET Client 5.40" 192.168.8.134 53619 "-" "-" "-" "-"]]></testEvent>
  </testEvents>

  <!-- pattern definitions -->
  <patternDefinitions>
    <pattern name="patLogModule"><![CDATA[TR|WF|AUDIT|NF|SYS]]></pattern>
    <pattern name="patStrEndSlash"><![CDATA[[^/]*]]></pattern>
    <pattern name="patRightParenthesis"><![CDATA[[^)]+]]></pattern>
  </patternDefinitions>

  <eventFormatRecognizer><![CDATA[<:gPatYear>-<:gPatMon>-<:gPatDay>\s+<:gPatTime>\.\d+\s+<:gPatTimeZone>\s+<:gPatHostName>\s+<:patLogModule>\s+]]></eventFormatRecognizer>

  <parsingInstructions>
    <switch>
      <case>
        <collectFieldsByRegex src="$_rawmsg">
          <regex><![CDATA[.*<_year:gPatYear>-<_mon:gPatMon>-<_day:gPatDay>\s+<_time:gPatTime>\.\d+\s+<_tz:gPatTimeZone>\s+<reptDevName:gPatHostName>\s+<_logType:patLogModule>\s+<_body:gPatMesgBody>]]></regex>
        </collectFieldsByRegex>
      </case>
      <default/>
    </switch>

    <setEventAttribute attr="eventSeverity">1</setEventAttribute>
    <setEventAttribute attr="eventAction">0</setEventAttribute>
    <setEventAttribute attr="eventType">Barracuda-Generic</setEventAttribute>
    <setEventAttribute attr="deviceTime">toDateTime($_mon, $_day, $_year, $_time, $_tz)</setEventAttribute>

    <choose>
      <when test="not_exist _logType"/>
      <when test="$_logType = 'NF'">
        <!-- Network Firewall logs (acls) -->
        <switch>
          <!-- documented format for WAF NF -->
          <case>
            <collectFieldsByRegex src="$_body">
              <regex><![CDATA[<eventSeverityCat:gPatWord>\s+<_proto:gPatWord>\s+<srcIpAddr:gPatIpAddr>\s+<srcIpPort:gPatInt>\s+<destIpAddr:gPatIpAddr>\s+<destIpPort:gPatInt>\s+<fwAction:gPatWord>\s+<fwRule:gPatStr>\s+<msg:gPatMesgBody>]]></regex>
            </collectFieldsByRegex>
          </case>
          <!-- actual sample logs observed -->
          <case>
            <collectFieldsByRegex src="$_body">
              <regex><![CDATA[<eventSeverityCat:gPatWord>\s+<_proto:gPatWord>\s+<destIpAddr:gPatIpAddr>\s+<destIpPort:gPatInt>\s+<fwAction:gPatWord>\s+<msg:gPatMesgBody>]]></regex>
            </collectFieldsByRegex>
          </case>
          <default/>
        </switch>
        <choose>
          <when test="exist fwAction">
            <setEventAttribute attr="eventType">combineMsgId("Barracuda-NetFirewall-", $fwAction)</setEventAttribute>
            <when test="$fwAction = 'DENY'">
              <setEventAttribute attr="eventAction">1</setEventAttribute>
            </when>
          </when>
          <otherwise>
            <setEventAttribute attr="eventType">Barracuda-NetFirewall-Generic</setEventAttribute>
          </otherwise>
        </choose>
      </when>
      <when test="$_logType = 'WF'">
        <!-- Web Firewall Logs -->
        <collectAndSetAttrByPosWithNestedSep src="$_body" L1Sep=" " L2Sep="&quot;&quot;, []">
          <attrPosMap attr="eventSeverityCat" pos="1"/>
          <attrPosMap attr="attackType" pos="2"/>
          <attrPosMap attr="srcIpAddr" pos="3"/>
          <attrPosMap attr="srcIpPort" pos="4"/>
          <attrPosMap attr="destIpAddr" pos="5"/>
          <attrPosMap attr="destIpPort" pos="6"/>
          <attrPosMap attr="fwRule" pos="7"/>
          <attrPosMap attr="type" pos="8"/>
          <attrPosMap attr="fwAction" pos="9"/>
          <attrPosMap attr="remedyAction" pos="10"/>
          <attrPosMap attr="_cookie" pos="11"/>
          <attrPosMap attr="httpMethod" pos="12"/>
          <attrPosMap attr="downloadURL" pos="13"/>
          <attrPosMap attr="appTransportProto" pos="14"/>
          <attrPosMap attr="sessionId" pos="15"/>
          <attrPosMap attr="httpUserAgent" pos="16"/>
          <attrPosMap attr="relayDevIpAddr" pos="17"/>
          <attrPosMap attr="_proxyPort" pos="18"/>
          <attrPosMap attr="user" pos="19"/>
          <attrPosMap attr="httpReferrer" pos="20"/>
        </collectAndSetAttrByPosWithNestedSep>
        <when test="exist fwAction">
          <when test="$fwAction = 'DENY'">
            <setEventAttribute attr="eventAction">1</setEventAttribute>
          </when>
        </when>
        <choose>
          <when test="exist attackType">
            <setEventAttribute attr="eventType">combineMsgId("Barracuda-WebFW-", $attackType)</setEventAttribute>
          </when>
          <otherwise>
            <setEventAttribute attr="eventType">Barracuda-WebFW-Generic</setEventAttribute>
          </otherwise>
        </choose>
      </when>
      <when test="$_logType = 'TR'">
        <!-- some fields have '; ' as separator for sub values, strip to just semicolon-->
        <setEventAttribute attr="_body">replaceStringByRegex($_body, ";\s+", ";")</setEventAttribute>
        <!-- web access/traffic logs -->
        <collectAndSetAttrByPosWithNestedSep src="$_body" L1Sep=" " L2Sep="&quot;&quot;, []">
          <attrPosMap attr="preNATDestIpAddr" pos="1"/>
          <attrPosMap attr="preNATDestIpPort" pos="2"/>
          <attrPosMap attr="srcIpAddr" pos="3"/>
          <attrPosMap attr="srcIpPort" pos="4"/>
          <attrPosMap attr="userId" pos="5"/>
          <attrPosMap attr="_certUser" pos="6"/>
          <attrPosMap attr="httpMethod" pos="7"/>
          <attrPosMap attr="appTransportProto" pos="8"/>
          <attrPosMap attr="_hostIPofServer" pos="9"/>
          <attrPosMap attr="httpVersion" pos="10"/>
          <attrPosMap attr="httpStatusCode" pos="11"/>
          <attrPosMap attr="sentBytes" pos="12"/>
          <attrPosMap attr="recvBytes" pos="13"/>
          <attrPosMap attr="cacheHit" pos="14"/>
          <attrPosMap attr="totalResponseTimeSum" pos="15"/>
          <attrPosMap attr="destIpAddr" pos="16"/>
          <attrPosMap attr="destIpPort" pos="17"/>
          <attrPosMap attr="serverResponseTimeSum" pos="18"/>
          <attrPosMap attr="sessionId" pos="19"/>
          <attrPosMap attr="type" pos="20"/>
          <attrPosMap attr="profileDetails" pos="21"/>
          <!-- PASSIVE, PROTECTED, OR UNPROTECTED -->
          <attrPosMap attr="fwAction" pos="22"/>
          <attrPosMap attr="status" pos="23"/>
          <attrPosMap attr="uriStem" pos="24"/>
          <attrPosMap attr="uriQuery" pos="25"/>
          <attrPosMap attr="httpReferrer" pos="26"/>
          <attrPosMap attr="httpCookie" pos="27"/>
          <attrPosMap attr="httpUserAgent" pos="28"/>
          <attrPosMap attr="relayDevIpAddr" pos="29"/>
          <attrPosMap attr="_proxyPort" pos="30"/>
          <attrPosMap attr="user" pos="31"/>
        </collectAndSetAttrByPosWithNestedSep>
        <when test="exist httpUserAgent">
          <!-- add the space back after ; for user agent -->
          <setEventAttribute attr="httpUserAgent">replaceStrInStr($httpUserAgent, ";", "; ")</setEventAttribute>
        </when>
        <choose>
          <when test="exist fwAction">
            <setEventAttribute attr="eventType">combineMsgId("Barracuda-AccessLog-", $fwAction)</setEventAttribute>
          </when>
          <otherwise>
            <setEventAttribute attr="eventType">Barracuda-AccessLog-Generic</setEventAttribute>
          </otherwise>
        </choose>
      </when>
      <when test="$_logType = 'AUDIT'">
        <!-- Audit Logs -->
        <setEventAttribute attr="eventType">Barracuda-Audit</setEventAttribute>
        <collectAndSetAttrByPosWithNestedSep src="$_body" L1Sep=" " L2Sep="&quot;&quot;">
          <attrPosMap attr="user" pos="1"/>
          <attrPosMap attr="type" pos="2"/>
          <attrPosMap attr="srcIpAddr" pos="3"/>
          <attrPosMap attr="srcIpPort" pos="4"/>
          <attrPosMap attr="action" pos="5"/>
          <attrPosMap attr="transactionId" pos="6"/>
          <attrPosMap attr="command" pos="7"/>
          <attrPosMap attr="changeSet" pos="8"/>
          <attrPosMap attr="objType" pos="9"/>
          <attrPosMap attr="osObjName" pos="10"/>
          <attrPosMap attr="_internalName" pos="11"/>
          <attrPosMap attr="oldObjValue" pos="12"/>
          <attrPosMap attr="newObjValue" pos="13"/>
          <attrPosMap attr="msg" pos="14"/>
        </collectAndSetAttrByPosWithNestedSep>
        <choose>
          <when test="exist action">
            <setEventAttribute attr="action">replaceStrInStr($action, " ", "-")</setEventAttribute>
            <setEventAttribute attr="eventType">combineMsgId("Barracuda-Audit-", $action)</setEventAttribute>
          </when>
          <otherwise>
            <setEventAttribute attr="eventType">Barracuda-Audit-Generic</setEventAttribute>
          </otherwise>
        </choose>
      </when>
      <when test="$_logType = 'SYS'">
        <!-- system logs -->
        <switch>
          <case>
            <collectFieldsByRegex src="$_body">
              <regex><![CDATA[<module:gPatWord>\s+<eventSeverityCat:gPatWord>\s+<_eventID:gPatInt>\s+<msg:gPatMesgBodyMin>\s*$]]></regex>
            </collectFieldsByRegex>
            <!-- e.g. Barracuda-Sys-51001 -->
            <setEventAttribute attr="eventType">combineMsgId("Barracuda-Sys-", $_eventID)</setEventAttribute>
          </case>
          <default>
            <setEventAttribute attr="eventType">Barracuda-Sys-Generic</setEventAttribute>
          </default>
        </switch>
      </when>
    </choose>

    <when test="exist _proto">
      <setEventAttribute attr="ipProto">convertStrToIntIpProto($_proto)</setEventAttribute>
    </when>
    <choose>
      <when test="not_exist eventSeverityCat"/>
      <when test="$eventSeverityCat = 'EMERGENCY'">
        <setEventAttribute attr="severity">10</setEventAttribute>
      </when>
      <when test="$eventSeverityCat IN 'ALERT,CRITICAL'">
        <setEventAttribute attr="severity">9</setEventAttribute>
      </when>
      <when test="$eventSeverityCat = 'ERROR'">
        <setEventAttribute attr="severity">8</setEventAttribute>
      </when>
      <when test="$eventSeverityCat = 'WARNING'">
        <setEventAttribute attr="severity">6</setEventAttribute>
      </when>
      <otherwise/>
    </choose>
  </parsingInstructions>
</eventParser>
