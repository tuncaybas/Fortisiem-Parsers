<eventParser name="OracleCASBParser">
  <deviceType>
    <Vendor>Oracle</Vendor>
    <Model>CASB Security</Model>
    <Version>ANY</Version>
  </deviceType>

  <testEvents>
    <testEvent><![CDATA[[FSM-OracleCASB-riskevent] [1][a.com][10.10.10.10] {"id":"11111111-1111-1111-1111-111111111111","uri":"/v1/events/riskevent?eventId=11111111-1111-1111-1111-111111111111&applicationInstanceId;=11111111-1111-1111-1111-111111111111","appname":"AWS","appinstance":"awse2e_01","appinstanceid":"11111111-1111-1111-1111-111111111111","snapdate":"2017-10-25","title":"DeleteSecurityGroup action in EC2 SecurityGroup \"JKSecurityGroup\"","additionalDetails":[{"Details":[{"name":"Actor","value":"funct_test_nonservice"},{"name":"Resource type","value":"EC2 SecurityGroup"},{"name":"Group","value":"JKSecurityGroup"},{"name":"Resource name","value":"[JKSecurityGroup]"},{"name":"Action","value":"DeleteSecurityGroup"},{"name":"Policy alert name","value":"EC2 - Instances Network Routes Network ACL VPN and Security Group changes"},{"name":"Occurred","value":"2017-10-25T17:17:29Z"},{"name":"recommendationkey","value":"AWS~PolicyAlert~ec2deletesecuritygroup"}],"Logdata":"{\"requestParameters\" :{\"groupName\" :\"JKSecurityGroup\"},\"responseElements\" :{\"_return\" :true},\"eventVersion\" :\"1.05\",\"eventTime\" :\"2017-10-25T17:17:29Z\",\"eventSource\" :\"ec2.amazonaws.com\",\"eventName\" :\"DeleteSecurityGroup\",\"awsRegion\" :\"us-east-1\",\"sourceIPAddress\" :\"54.191.225.186\",\"userAgent\" :\"aws-sdk-java/1.10.54 Linux/3.13.0-35-generic Java_HotSpot(TM)_64-Bit_Server_VM/25.60-b23/1.8.0_60\",\"userIdentity\" :{\"type\" :\"IAMUser\",\"principalId\" :\"AIDAJVECQI6KOIYZMM42A\",\"arn\" :\"arn:aws:iam::141111462111:user/funct_test_nonservice\",\"accountId\" :\"141111462111\",\"accessKeyId\" :\"AXXXXXXXXXXXXXXXXXXX\",\"userName\" :\"funct_test_nonservice\"},\"requestID\" :\"11111111-1111-1111-1111-111111111111\",\"eventID\" :\"11111111-1111-1111-1111-111111111111\"}"}],"category":"Policy alert","priority":"High","status":"Open","createdon":"2017-10-25T17:33:55.000Z","realeventtime":"2017-10-25T17:17:29.000Z"}]]></testEvent>
    <testEvent><![CDATA[[FSM-OracleCASB-Auth] [1][a.com][10.10.10.10] {"appname":"SFDC","appinstance":"publiceventsapi","appInstanceId":"11111111-1111-1111-1111-111111111111","userRiskDetails":[{"displayname":"Risk Level","value":"Normal"},{"displayname":"User name","value":"andylemarc@mycompany.com"},{"displayname":"Maximum Risk Score","value":"00"},{"displayname":"Reasons","value":"[\"11111111-1111-1111-1111-111111111111\", \"2017-10-24T23:29:38Z\", {\"MSG_NO_RISK_FACTORS\":\"No risk factors\"}]"},{"displayname":"Detected Date","value":"2017-10-24T00:00:00Z"},{"displayname":"ReasonsAverage","value":"{}"},{"displayname":"ReasonsCounts","value":"{}"},{"displayname":"Detected Date ISOFormat","value":"2017-10-24T00:00:00Z"}]}]]></testEvent>
  </testEvents>

  <eventFormatRecognizer><![CDATA[\[FSM-OracleCASB-]]></eventFormatRecognizer>

  <parsingInstructions>
    <collectFieldsByRegex src="$_rawmsg">
      <regex><![CDATA[\[FSM-OracleCASB-<_type:gPatWord>\]\s+\[<phCustId:gPatInt>\](?:\[<reptDevName:gPatStrRightSB>\]\[<reptDevIpAddr:gPatStrRightSB>\])? <_body:gPatMesgBody>]]></regex>
    </collectFieldsByRegex>

    <setEventAttribute attr="eventType">combineMsgId("Oracle-CASB-", $_type)</setEventAttribute>
    <setEventAttribute attr="extEventRecvProto">ORACLE_CASB_API</setEventAttribute>

    <choose>
      <when test="$_type = 'riskevent'">
        <collectAndSetAttrByJSON src="$_body">
          <attrKeyMap attr="deviceTime" key="realeventtime"/>
          <attrKeyMap attr="_evtType" key="category"/>
          <attrKeyMap attr="_severity" key="priority"/>
          <attrKeyMap attr="alarmState" key="status"/>
          <attrKeyMap attr="oid" key="id"/>
          <attrKeyMap attr="infoURL" key="uri"/>
          <attrKeyMap attr="appName" key="appname"/>
          <attrKeyMap attr="instanceName" key="appinstance"/>
          <attrKeyMap attr="ec2InstanceId" key="appinstanceid"/>
          <attrKeyMap attr="snapshotCreateTime" key="snapdate"/>
          <attrKeyMap attr="title" key="title"/>
          <attrKeyMap attr="details" key="additionalDetails"/>
        </collectAndSetAttrByJSON>
        <when test="exist $_evtType">
          <setEventAttribute attr="_evtType">replaceStrInStr($_evtType, " ", "-")</setEventAttribute>
          <setEventAttribute attr="eventType">combineMsgId("Oracle-CASB-", $_type, "-", $_evtType)</setEventAttribute>
        </when>
        <when test="exist _severity">
          <choose>
            <when test="$_severity = 'High'">
              <setEventAttribute attr="eventSeverity">7</setEventAttribute>
            </when>
          </choose>
        </when>
      </when>

      <when test="$_type = 'riskScore'">
        <collectAndSetAttrByJSON src="$_body">
          <attrKeyMap attr="appName" key="appname"/>
          <attrKeyMap attr="instanceName" key="appinstance"/>
          <attrKeyMap attr="ec2InstanceId" key="appInstanceId"/>
          <attrKeyMap attr="details" key="userRiskDetails"/>
        </collectAndSetAttrByJSON>
      </when>

    </choose>
  </parsingInstructions>
</eventParser>
