<eventParser name="MalwarebytesBreachDetectionParser">
  <deviceType>
    <Vendor>Malwarebytes</Vendor>
    <Model>Malwarebytes Breach Remediation</Model>
    <Version>ANY</Version>
  </deviceType>

  <testEvents>
    <testEvent><![CDATA[2020-11-25T17:18:46Z example1 CEF:0|Malwarebytes|Malwarebytes Breach Remediation|Version: 4.1.1.84 [eng:Version: 3.0.0.1090 rul:2020.11.25.17 act:Version: 3.2.0.266 sws:Version: 4.3.0.279]|1000|Scan Started|1|cs3=11111111-1111-1111-1111-111111111111 cs3Label=SessionId cs5=mbbr  scan -full -remove -noreboot cs5Label=CmdLine dvchost=0001-KEXAMPLO deviceMacAddress=DC:10:10:10:10:10 suser=k.examplo outcome=succeeded]]></testEvent>
    <testEvent><![CDATA[2020-11-20T22:00:28Z example1 CEF:0|Malwarebytes|Malwarebytes Breach Remediation|Version: 3.6.5.379 [eng:Version: 3.0.0.1007 rul:2020.11.20.22 act:Version: 3.2.0.257 sws:Version: 4.3.0.261]|1003|Scan Ended|1|cs3=11111111-1111-1111-1111-111111111111 cs3Label=SessionId cs5=mbbr  scan -full -remove -noreboot cs5Label=CmdLine dvchost=NIT-DJ deviceMacAddress=DC:10:10:10:10:10 suser=dj.nguyen outcome=succeeded]]></testEvent>

  </testEvents>

  <patternDefinitions>
    <pattern name="patStrEndSep"><![CDATA[[^|]*]]></pattern>
  </patternDefinitions>

  <eventFormatRecognizer><![CDATA[\s*CEF\s*:\d+\|Malwarebytes\|Malwarebytes Breach Remediation\|(?:<:patStrEndSep>\|){4}\s*]]></eventFormatRecognizer>

  <parsingInstructions>
    <collectFieldsByRegex src="$_rawmsg">
      <regex><![CDATA[<:gPatSyslogPRI>?\s*<_year:gPatYear>-<_mon:gPatMonNum>-<_day:gPatDay>T<_time:gPatTime><_tz:gPatTimeZone>\s+<:gPatStr>\s+CEF\s*:<_body:gPatMesgBody>]]></regex>
    </collectFieldsByRegex>
    <setEventAttribute attr="deviceTime">toDateTime($_mon, $_day, $_year, $_time, $_tz)</setEventAttribute>

    <when test="matches($_body, '\\\|')">
      <setEventAttribute attr="_body">replaceStrInStr($_body, "\|", "::TEMP::")</setEventAttribute>
    </when>
    <setEventAttribute attr="_body">replaceStrInStr($_body, "|", "::SEP::")</setEventAttribute>
    <when test="matches($_body, '::TEMP::')">
      <setEventAttribute attr="_body">replaceStrInStr($_body, "::TEMP::", "|")</setEventAttribute>
    </when>

    <collectAndSetAttrByPos sep="::SEP::" src="$_body">
      <attrPosMap attr="version" pos="1"/>
      <attrPosMap attr="_devVendor" pos="2"/>
      <attrPosMap attr="_devProduct" pos="3"/>
      <attrPosMap attr="appVersion" pos="4"/>
      <attrPosMap attr="ipsSignatureId" pos="5"/>
      <attrPosMap attr="_name" pos="6"/>
      <attrPosMap attr="_severity" pos="7"/>
      <attrPosMap attr="_extension" pos="8"/>
    </collectAndSetAttrByPos>

    <setEventAttribute attr="_name">replaceStringByRegex($_name, "\s+", "-")</setEventAttribute>
    <setEventAttribute attr="eventType">combineMsgId("MalwareBytesBreach-", $_name)</setEventAttribute>

    <setEventAttribute attr="_extension">replaceStrInStr($_extension, "\=", "=")</setEventAttribute>
    <collectFieldsByKeyValuePair kvsep="=" sep=" " src="$_extension">
      <attrKeyMap attr="_cs1Label" key="cs1Label"/>
      <attrKeyMap attr="_cs1" key="cs1"/>
      <attrKeyMap attr="_cs2Label" key="cs2Label"/>
      <attrKeyMap attr="_cs2" key="cs2"/>
      <attrKeyMap attr="_cs3Label" key="cs3Label"/>
      <attrKeyMap attr="_cs3" key="cs3"/>
      <attrKeyMap attr="_cs4Label" key="cs4Label"/>
      <attrKeyMap attr="_cs4" key="cs4"/>
      <attrKeyMap attr="_cs5Label" key="cs5Label"/>
      <attrKeyMap attr="_cs5" key="cs5"/>
      <attrKeyMap attr="virusAction" key="act"/>
      <attrKeyMap attr="appCategory" key="cat"/>
      <attrKeyMap attr="hostMACAddr" key="deviceMacAddress"/>
      <attrKeyMap attr="hostName" key="dvchost"/>
      <attrKeyMap attr="_endTime" key="end"/>
      <attrKeyMap attr="filePath" key="filePath"/>
      <attrKeyMap attr="msg" key="msg"/>
      <attrKeyMap attr="resultType" key="outcome"/>
      <attrKeyMap attr="_deviceTime" key="rt"/>
      <attrKeyMap attr="_startTime" key="start"/>
      <attrKeyMap attr="user" key="suser"/>
    </collectFieldsByKeyValuePair>


    <choose>
      <when test="not_exist _cs1Label"/>
      <when test="not_exist _cs1"/>
      <when test="$_cs1Label = 'MalwareName'">
        <setEventAttribute attr="virusName">$_cs1</setEventAttribute>
      </when>
    </choose>

    <choose>
      <when test="not_exist _cs2Label"/>
      <when test="not_exist _cs2"/>
      <when test="$_cs2Label = 'MalwareHash'">
        <setEventAttribute attr="hashMD5">$_cs2</setEventAttribute>
      </when>
    </choose>

    <choose>
      <when test="not_exist _cs3Label"/>
      <when test="not_exist _cs3"/>
      <when test="$_cs3Label = 'SessionId'">
        <setEventAttribute attr="sessionId">$_cs3</setEventAttribute>
      </when>
    </choose>

    <choose>
      <when test="not_exist _cs4Label"/>
      <when test="not_exist _cs4"/>
      <when test="$_cs4Label = 'MalwareClass'">
        <setEventAttribute attr="virusType">$_cs4</setEventAttribute>
      </when>
    </choose>

    <choose>
      <when test="not_exist _cs5Label"/>
      <when test="not_exist _cs5"/>
      <when test="$_cs5Label = 'CmdLine'">
        <setEventAttribute attr="command">$_cs5</setEventAttribute>
      </when>
    </choose>

    <when test="exist _rt">
      <switch>
        <case>
          <collectFieldsByRegex src="$_rt">
            <regex><![CDATA[<_year2:gPatYear>-<_mon2:gPatMon>-<_day2:gPatDay>T<_time2:gPatTime><_tz2:gPatTimeZone>]]></regex>
          </collectFieldsByRegex>
          <setEventAttribute attr="eventTime">toDateTime($_mon2, $_day2, $_year2, $_time2, $_tz2)</setEventAttribute>
        </case>
        <default/>
      </switch>
    </when>

    <when test="exist _endTime">
      <switch>
        <case>
          <collectFieldsByRegex src="$_endTime">
            <regex><![CDATA[<_year2:gPatYear>-<_mon2:gPatMon>-<_day2:gPatDay>T<_time2:gPatTime><_tz2:gPatTimeZone>]]></regex>
          </collectFieldsByRegex>
          <setEventAttribute attr="endTime">toDateTime($_mon2, $_day2, $_year2, $_time2, $_tz2)</setEventAttribute>
        </case>
        <default/>
      </switch>
    </when>

    <when test="exist _startTime">
      <switch>
        <case>
          <collectFieldsByRegex src="$_startTime">
            <regex><![CDATA[<_year2:gPatYear>-<_mon2:gPatMon>-<_day2:gPatDay>T<_time2:gPatTime><_tz2:gPatTimeZone>]]></regex>
          </collectFieldsByRegex>
          <setEventAttribute attr="startTime">toDateTime($_mon2, $_day2, $_year2, $_time2, $_tz2)</setEventAttribute>
        </case>
        <default/>
      </switch>
    </when>

    <choose>
      <when test="$_severity = '0'">
        <setEventAttribute attr="eventSeverity">1</setEventAttribute>
      </when>
      <otherwise>
        <setEventAttribute attr="eventSeverity">$_severity</setEventAttribute>
      </otherwise>
    </choose>
  </parsingInstructions>
</eventParser>
