<eventParser name="FireEyeETPParser">
  <deviceType>
    <Vendor>FireEye</Vendor>
    <Model>Email Threat Prevention</Model>
    <Version>ANY</Version>
  </deviceType>

  <testEvents>
    <testEvent><![CDATA[2019-06-03T19:19:54.247Z hostname CEF:0|FireEye|ETP|2.0|etp|malicious email|10|rt=Mon, 03 Jun 2019 19:17:30 +0000 suser=user1@example1.com duser=user2@example2.com dusercc= emailsubj=Todays News malfename=Phish.URL malname=hxxp://celticdragonsnetball.com/wp-content/group-4/Zantac-300mg-150mg/ fileHash=1e2600e324a8312342ab5ee28e863047 etpurl=https://etp.us.fireeye.com/alert/80261234/ client=user3 clientd=example3.com atiLevel= atiAttrib= atiType= atiName=]]></testEvent>
  </testEvents>

  <eventFormatRecognizer><![CDATA[\s*CEF\s*:\d+\|FireEye\|ETP\|]]></eventFormatRecognizer>
  <parsingInstructions>
    <switch>
      <case>
        <collectFieldsByRegex src="$_rawmsg">
          <regex><![CDATA[<:gPatSyslogPRI>?\s*<_year:gPatYear>-<_mon:gPatMon>-<_day:gPatDay>T<_time:gPatTimeMSec><_tz:gPatTimeZone>\s+<reptDevName:gPatStr>\s+CEF\s*:<_body:gPatMesgBody>]]></regex>
        </collectFieldsByRegex>
        <setEventAttribute attr="deviceTime">toDateTime($_mon, $_day, $_year, $_time, $_tz)</setEventAttribute>
      </case>
      <case>
        <collectFieldsByRegex src="$_rawmsg">
          <regex><![CDATA[^<reptDevName:gPatStr>\s+CEF\s*:<_body:gPatMesgBody>]]></regex>
        </collectFieldsByRegex>
      </case>
      <default/>
    </switch>
    <setEventAttribute attr="eventType">FireEye-ETP-Generic</setEventAttribute>
    <when test="matches($_body, '\\\|')">
      <setEventAttribute attr="_body">replaceStrInStr($_body, "\|", "::TEMP::")</setEventAttribute>
    </when>
    <setEventAttribute attr="_body">replaceStrInStr($_body, "|", "::SEP::")</setEventAttribute>
    <when test="matches($_body, '::TEMP::')">
      <setEventAttribute attr="_body">replaceStrInStr($_body, "::TEMP::", "|")</setEventAttribute>
    </when>
    <collectAndSetAttrByPos sep="::SEP::" src="$_body">
      <attrPosMap attr="version" pos="1"/>
      <attrPosMap attr="_devProduct" pos="3"/>
      <attrPosMap attr="appVersion" pos="4"/>
      <attrPosMap attr="_sigId" pos="5"/>
      <attrPosMap attr="categoryType" pos="6"/>
      <attrPosMap attr="_severity" pos="7"/>
      <attrPosMap attr="_extension" pos="8"/>
    </collectAndSetAttrByPos>
    <setEventAttribute attr="_extension">replaceStrInStr($_extension, "\=", "=")</setEventAttribute>
    <collectFieldsByKeyValuePair kvsep="=" sep=" " src="$_extension">
      <attrKeyMap attr="_rt" key="rt"/>
      <attrKeyMap attr="srcUser" key="suser"/>
      <attrKeyMap attr="destUser" key="duser"/>
      <attrKeyMap attr="hashCode" key="fileHash"/>
      <attrKeyMap attr="mailSubject" key="emailsubj"/>
      <attrKeyMap attr="virusType" key="malfename"/>
      <attrKeyMap attr="downloadURL" key="malname"/>
      <attrKeyMap attr="mailDomain" key="clientd"/>
      <attrKeyMap attr="infoURL" key="etpurl"/>
      <!--
  dusercc=
  client=
  atiLevel=
  atiAttrib=
  atiType=
  atiName=
  -->
    </collectFieldsByKeyValuePair>
    <!-- MMM dd yyyy HH:mm:ss or milliseconds since epoch (Jan 1st 1970). -->
    <when test="exist _rt">
      <switch>
        <case>
          <collectFieldsByRegex src="$_rt">
            <!-- Mon, 03 Jun 2019 19:17:30 +0000 -->
            <regex><![CDATA[<:gPatStr>,\s+<_day1:gPatDay>\s+<_mon1:gPatMon>\s+<_year1:gPatYear>\s+<_time1:gPatTime>]]></regex>
          </collectFieldsByRegex>
          <setEventAttribute attr="eventTime">toDateTime($_mon1, $_day1, $_year1, $_time1)</setEventAttribute>
        </case>
        <case>
          <collectFieldsByRegex src="$_rt">
            <regex><![CDATA[^<eventTime:gPatInt>\d{3}$]]></regex>
          </collectFieldsByRegex>
        </case>
        <default/>
      </switch>
    </when>
    <setEventAttribute attr="eventType">combineMsgId("FireEye-",$_devProduct, "-", $categoryType)</setEventAttribute>
    <setEventAttribute attr="eventType">replaceStringByRegex($eventType, ":\s+", "-")</setEventAttribute>
    <setEventAttribute attr="eventType">replaceStringByRegex($eventType, "\s+", "-")</setEventAttribute>
    <choose>
      <when test="$_severity = '0'">
        <setEventAttribute attr="eventSeverity">1</setEventAttribute>
      </when>
      <otherwise>
        <setEventAttribute attr="eventSeverity">$_severity</setEventAttribute>
      </otherwise>
    </choose>
  </parsingInstructions>
</eventParser>
