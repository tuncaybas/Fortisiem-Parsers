<eventParser name="BlueCoatParser">
  <deviceType>
    <Vendor>Blue Coat</Vendor>
    <Model>SGOS Web Proxy</Model>
    <Version>ANY</Version>
  </deviceType>

  <!-- examples
Format main ELFF
date time time-taken c-ip sc-status s-action sc-bytes cs-bytes cs-method cs-uri-scheme cs-host cs-uri-port cs-uri-path cs-uri-query cs-username cs-auth-group s-hierarchy s-supplier-name rs(Content-Type) cs(Referer) cs(User-Agent) sc-filter-result cs-categories x-virus-id s-ip
<2> Jun 24 16:10:28 example.com BluecoatWebLog	0	2010-06-24 23:09:52 2 192.168.22.21 304 TCP_HIT 345 1091 GET http abc.com 80 /image.aspx ?uuid=11111111-1111-1111-1111-111111111111&w=136&h=102 - - DIRECT 10.1.1.1 image/jpeg - "Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; InfoPath.2; Windows Live Messenger 14.0.8089.0726)" PROXIED "none" - 172.16.0.141
	   -->

  <patternDefinitions>
    <pattern name="patField"><![CDATA["[^"]*"|\S+]]></pattern>
  </patternDefinitions>

  <eventFormatRecognizer><![CDATA[BluecoatWebLog]]></eventFormatRecognizer>

  <testEvents>
    <testEvent><![CDATA[<2> Jun 25 11:15:33 example.com BluecoatWebLog	0	2010-06-25 18:13:34 2021 192.168.22.21 200 TCP_TUNNELED 820 1075 CONNECT tcp abc.com 443 / - - - NONE 172.16.0.141 - - "WebEx Outlook Integration Http Agent" PROXIED "none" - 22.22.22.22]]></testEvent>
    <testEvent><![CDATA[<2> Jun 25 11:15:33 example.com BluecoatWebLog	0	2017-05-15 13:17:06 1 10.1.29.30 - - 10.227.0.103 10.227.0.103 Unavailable - - OBSERVED "Non-Viewable/Infrastructure" -  200 TCP_ACCELERATED CONNECT - tcp clients1.google.com 443 / - - "Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36" 10.227.0.103 39 227 - "unavailable" "unavailable" unavailable 1a8526153ec0699a-00000000093c8647-000000005919aa52 - -]]></testEvent>
  </testEvents>

  <parsingInstructions>

    <collectFieldsByRegex src="$_rawmsg">
      <regex><![CDATA[<:gPatSyslogPRI>\s+<_mon:gPatMon>\s+<_day:gPatDay>\s+<_time:gPatTime>\s+<:gPatHostName>\s+BluecoatWebLog\s+\d+\s+<_year:gPatYear>-<_mon:gPatMonNum>-<_day:gPatDay>\s+<_time:gPatTime>\s+<durationMSec:gPatInt>\s+<srcIpAddr:gPatIpAddr>\s+<_body:gPatMesgBody>]]></regex>
    </collectFieldsByRegex>

    <setEventAttribute attr="eventType">Bluecoat-SGOS-Generic</setEventAttribute>
    <!-- parsing common fields -->
    <choose>
      <when test="matches($_body, '^#')"/>
      <otherwise>
        <switch>
          <case>
            <collectFieldsByRegex src="$_body">
              <regex><![CDATA[^<httpStatusCode:gPatInt>\s+<httpProxyAction:patField>\s+<sentBytes64:gPatInt>\s+<recvBytes64:gPatInt>\s+<httpMethod:patField>\s+<_scheme:patField>\s+<destName:gPatHostName>\s+<destIpPort:gPatInt>\s+<uriStem:patField>\s+<uriQuery:patField>\s+<user:patField>\s+<userGrp:patField>\s+<_hierarchy:patField>\s+<_destIpAddr:patField>\s+<httpContentType:patField>\s+<httpReferrer:patField>\s+<httpUserAgent:patField>\s+<bcFilterResult:patField>\s+<webCategory:patField>\s+<virusName:patField>\s+<reptDevIpAddr:gPatIpAddr>]]></regex>
            </collectFieldsByRegex>
            <when test="$_destIpAddr != '-'">
              <setEventAttribute attr="destIpAddr">$_destIpAddr</setEventAttribute>
            </when>
          </case>
          <case>
            <collectFieldsByRegex src="$_body">
              <regex><![CDATA[^<user:patField>\s+<userGrp:patField>\s+<destDomain:gPatStr>\s+<destIpAddr:gPatIpAddr>\s+<:patField>\s+<:patField>\s+<:patField>\s+<bcFilterResult:patField>\s+<webCategory:patField>\s+<httpReferrer:patField>\s+<httpStatusCode:gPatInt>\s+<httpProxyAction:patField>\s+<httpMethod:patField>\s+<httpContentType:patField>\s+<_scheme:patField>\s+<destName:gPatHostName>\s+<destIpPort:gPatInt>\s+<uriStem:patField>\s+<uriQuery:patField>\s+<httpFileExt:patField>\s+<httpUserAgent:patField>\s+<:patField>\s+<recvBytes64:gPatInt>\s+<sentBytes64:gPatInt>\s+<virusName:patField>]]></regex>
            </collectFieldsByRegex>
          </case>
          <default/>
        </switch>

        <when test="exist sentBytes64">
          <when test="exist recvBytes64">
            <setEventAttribute attr="totBytes64">add($sentBytes64, $recvBytes64)</setEventAttribute>
          </when>
        </when>

        <when test="exist destIpAddr">
          <when test="not_private_ip destIpAddr">
            <when test="exist destName">
              <setEventAttribute attr="domainEntropy">calcDomainEntropy($destName)</setEventAttribute>
            </when>
          </when>
        </when>

        <setEventAttribute attr="ipProto">convertStrToIntIpProto($_scheme)</setEventAttribute>

        <choose>
          <when test="exist _year">
            <setEventAttribute attr="deviceTime">toDateTime($_mon, $_day, $_year, $_time)</setEventAttribute>
          </when>
          <otherwise>
            <setEventAttribute attr="deviceTime">toDateTime($_mon, $_day, $_time)</setEventAttribute>
          </otherwise>
        </choose>

        <setEventAttribute attr="eventAction">0</setEventAttribute>
        <setEventAttribute attr="totFlows">1</setEventAttribute>

        <choose>
          <when test="not_exist httpStatusCode"/>
          <when test="$httpStatusCode = '0'">
            <choose>
              <when test="$httpProxyAction IN 'DENIED,TCP_DENIED,UDP_DENIED,FAILED'">
                <setEventAttribute attr="eventType">Bluecoat-SGOS-Web-Request-Denied</setEventAttribute>
                <setEventAttribute attr="eventSeverity">5</setEventAttribute>
              </when>
              <when test="$bcFilterResult = 'DENIED'">
                <setEventAttribute attr="eventType">Bluecoat-SGOS-Web-Request-Denied</setEventAttribute>
                <setEventAttribute attr="eventSeverity">5</setEventAttribute>
              </when>
              <otherwise>
                <setEventAttribute attr="eventType">Bluecoat-SGOS-Web-Request-Success</setEventAttribute>
                <setEventAttribute attr="eventSeverity">1</setEventAttribute>
              </otherwise>
            </choose>
          </when>
          <otherwise>
            <when test="matches($httpStatusCode, '^2')">
              <setEventAttribute attr="eventType">Bluecoat-SGOS-Web-Request-Success</setEventAttribute>
              <setEventAttribute attr="eventSeverity">1</setEventAttribute>
            </when>

            <when test="matches($httpStatusCode, '^3')">
              <setEventAttribute attr="eventType">Bluecoat-SGOS-Web-Request-Redirect</setEventAttribute>
              <setEventAttribute attr="eventSeverity">1</setEventAttribute>
            </when>

            <when test="$httpStatusCode = '401'">
              <setEventAttribute attr="eventType">Bluecoat-SGOS-Web-Client-Access-Denied</setEventAttribute>
              <setEventAttribute attr="eventSeverity">5</setEventAttribute>
            </when>

            <when test="$httpStatusCode = '403'">
              <setEventAttribute attr="eventType">Bluecoat-SGOS-Web-Forbidden-Access-Denied</setEventAttribute>
              <setEventAttribute attr="eventSeverity">5</setEventAttribute>
            </when>

            <when test="$httpStatusCode = '400'">
              <setEventAttribute attr="eventType">Bluecoat-SGOS-Web-Bad-Request</setEventAttribute>
              <setEventAttribute attr="eventSeverity">5</setEventAttribute>
            </when>

            <when test="$httpStatusCode = '411'">
              <setEventAttribute attr="eventType">Bluecoat-SGOS-Web-Length-Reqd-Access-Denied</setEventAttribute>
              <setEventAttribute attr="eventSeverity">5</setEventAttribute>
            </when>

            <when test="matches($httpStatusCode, '^4')">
              <setEventAttribute attr="eventType">Bluecoat-SGOS-Web-Client-Error</setEventAttribute>
              <setEventAttribute attr="eventSeverity">5</setEventAttribute>
              <setEventAttribute attr="eventAction">1</setEventAttribute>
            </when>

            <when test="matches($httpStatusCode, '^5')">
              <setEventAttribute attr="eventType">Bluecoat-SGOS-Web-Server-Error</setEventAttribute>
              <setEventAttribute attr="eventSeverity">6</setEventAttribute>
              <setEventAttribute attr="eventAction">1</setEventAttribute>
            </when>
          </otherwise>
        </choose>

        <when test="exist webCategory">
          <switch>
            <case>
              <collectFieldsByRegex src="$webCategory">
                <regex><![CDATA[^"<webCategory:gPatMesgBody>"$]]></regex>
              </collectFieldsByRegex>
            </case>
            <default/>
          </switch>
        </when>

        <when test="exist httpUserAgent">
          <switch>
            <case>
              <collectFieldsByRegex src="$httpUserAgent">
                <regex><![CDATA[^"<httpUserAgent:gPatMesgBody>"$]]></regex>
              </collectFieldsByRegex>
            </case>
            <default/>
          </switch>
        </when>
      </otherwise>
    </choose>
  </parsingInstructions>
</eventParser>
